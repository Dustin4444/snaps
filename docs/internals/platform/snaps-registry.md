# Snaps Registry

The Snaps Registry contains a list of snaps that are available to be installed
(allow-listed) and snaps that are blocked from being installed (block-listed).
At the moment, the registry is a JSON file that is hosted on the MetaMask
infrastructure. In the future, we may move to a smart contract based registry.

The registry is used by the [Snap Controller] to determine which snaps are
allowed to be installed. The [Snap Controller] will check the registry when a
snap is installed, and if the snap is not in the registry, it will not be
installed.

## JSON-based registry

For the current implementation, the registry is a JSON file that is hosted on
the MetaMask infrastructure. The registry file can be found in a separate
repository: [Snaps Registry]. The hosted version consists of two files:

- `registry.json`: The main registry file. This file contains a list of snaps
  that are allowed to be installed, or blocked from being installed.
- `signature.json`: The signature file. This file contains the signature of
  the registry file, signed when the registry is updated. This allows us to
  verify that the registry file has not been tampered with.

When the registry is updated, the signature file is re-generated by the
CI/CD pipeline. The signature is generated using the `sign-registry` script from
the [Snaps Registry] repository.

These files are fetched by the [JsonSnapsRegistry] class, which is an
implementation of the registry interface. It checks the signature of the
registry file, by checking it against a known public key. If the signature is
not valid, the registry will not be loaded. Depending on the `requireAllowlist`
feature flag, the [Snap Controller] will not allow any snaps to be installed if
the registry is not loaded. This feature flag is enabled by default in the
stable version of the MetaMask extension.

## Smart contract based registry

In the future, we may move to a smart contract based registry. This would allow
us to have a decentralized registry, and allow snap developers to register their
snaps themselves. This is currently a work in progress. Progress can be tracked
in the [Permissionless Snaps Registry] repository.

## Checking if snaps are allowed to be installed

The process of checking if snaps are allowed to be installed involves the following steps:

1. **Fetch the registry**: The Snap Controller fetches the registry file from the MetaMask infrastructure.
2. **Verify the signature**: The Snap Controller verifies the signature of the registry file using the known public key.
3. **Check the allowlist**: The Snap Controller checks if the snap is in the allowlist. If the snap is in the allowlist, it is allowed to be installed.
4. **Check the blocklist**: If the snap is not in the allowlist, the Snap Controller checks if the snap is in the blocklist. If the snap is in the blocklist, it is not allowed to be installed.
5. **Default behavior**: If the snap is not in either the allowlist or the blocklist, the Snap Controller will follow the default behavior based on the `requireAllowlist` feature flag. If the feature flag is enabled, the snap will not be allowed to be installed. If the feature flag is disabled, the snap will be allowed to be installed.

This process ensures that only snaps that are explicitly allowed by the registry can be installed, providing an additional layer of security and control over the snaps that are used in the MetaMask extension.

[snap controller]: ./snap-controller.md
[jsonsnapsregistry]: ../../../packages/snaps-controllers/src/snaps/registry/json.ts
[snaps registry]: https://github.com/MetaMask/snaps-registry
[permissionless snaps registry]: https://github.com/MetaMask/permissionless-snaps-registry
